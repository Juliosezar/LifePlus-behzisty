<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ویرایش پرونده</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.css">
    <script type="text/javascript" src="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.js"></script>

    <style>
        body { font-family: 'Vazirmatn', sans-serif; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .delete-btn { cursor: pointer; color: #ef4444; transition: all 0.2s; }
        .delete-btn:hover { color: #b91c1c; transform: scale(1.1); }
        .error-text { color: #dc2626; font-size: 0.75rem; margin-top: 0.25rem; font-weight: 500; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-24">

    <!-- HEADER (Amber Theme) -->
    <header class="bg-white shadow-sm sticky top-0 z-50 border-b border-amber-100">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <span class="bg-amber-100 text-amber-600 p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                </span>
                ویرایش پرونده: {{ form.instance.first_name }} {{ form.instance.last_name }}
            </h1>
            <div class="flex gap-2">
                <a href="{% url 'cases:case_delete' form.instance.pk %}" class="text-red-500 hover:text-red-700 text-sm font-medium flex items-center gap-1 border border-red-200 bg-red-50 px-3 py-1 rounded-lg hover:bg-red-100 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    حذف پرونده
                </a>
                <a href="{% url 'accounts:home' %}" class="text-gray-500 hover:text-amber-700 text-sm font-medium flex items-center gap-1 bg-gray-50 px-3 py-1 rounded-lg border hover:border-amber-300 transition">
                    بازگشت
                </a>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8">
        
        <form method="post" class="space-y-8" novalidate id="main-form">
            {% csrf_token %}

            <!-- Errors -->
            {% if form.non_field_errors or disabilities.non_form_errors or family.non_form_errors %}
            <div class="bg-red-50 border-r-4 border-red-500 p-5 rounded-xl mb-6 shadow-sm">
                <p class="font-bold text-red-800">لطفا خطاهای عمومی زیر را بررسی کنید:</p>
                <div class="text-sm text-red-600 space-y-1 mt-2">
                    {{ form.non_field_errors }}
                    {{ disabilities.non_form_errors }}
                    {{ reasons.non_form_errors }}
                    {{ recovered.non_form_errors }}
                    {{ family.non_form_errors }}
                    {{ notes.non_form_errors }}
                </div>
            </div>
            {% endif %}

            <!-- 1. IDENTITY -->
            <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                <h2 class="text-lg font-bold text-amber-800 mb-6 pb-2 border-b border-amber-100">1. اطلاعات هویتی</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div><label class="block mb-2 text-sm text-gray-700">{{ form.first_name.label }}</label>{{ form.first_name }}{% for error in form.first_name.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                    <div><label class="block mb-2 text-sm text-gray-700">{{ form.last_name.label }}</label>{{ form.last_name }}{% for error in form.last_name.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                    <div><label class="block mb-2 text-sm text-gray-700">{{ form.gender.label }}</label>{{ form.gender }}{% for error in form.gender.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                    <div><label class="block mb-2 text-sm text-gray-700">{{ form.military_serveice.label }}</label>{{ form.military_serveice }}{% for error in form.military_serveice.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                    <div><label class="block mb-2 text-sm text-gray-700">{{ form.national_id.label }}</label>{{ form.national_id }}{% for error in form.national_id.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                    <div><label class="block mb-2 text-sm text-gray-700">{{ form.birth_certificate_number.label }}</label>{{ form.birth_certificate_number }}{% for error in form.birth_certificate_number.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                    <div><label class="block mb-2 text-sm text-gray-700">{{ form.date_of_birth.label }}</label><div class="relative">{{ form.date_of_birth }}</div>{% for error in form.date_of_birth.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                    <div><label class="block mb-2 text-sm text-gray-700">{{ form.birth_place.label }}</label>{{ form.birth_place }}{% for error in form.birth_place.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                    <div><label class="block mb-2 text-sm text-gray-700">{{ form.education.label }}</label>{{ form.education }}{% for error in form.education.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                    <div><label class="block mb-2 text-sm text-gray-700">{{ form.field_of_study.label }}</label>{{ form.field_of_study }}{% for error in form.field_of_study.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                </div>
            </div>

            <!-- 2. STATUS & JOB -->
            <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                <h2 class="text-lg font-bold text-amber-800 mb-6 pb-2 border-b border-amber-100">2. وضعیت سکونت و شغلی</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div><label class="block mb-2 text-sm text-gray-700">{{ form.phone_number.label }}</label>{{ form.phone_number }}{% for error in form.phone_number.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                    <div><label class="block mb-2 text-sm text-gray-700">{{ form.home_phone_number.label }}</label>{{ form.home_phone_number }}{% for error in form.home_phone_number.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                    <div><label class="block mb-2 text-sm text-gray-700">{{ form.job.label }}</label>{{ form.job }}{% for error in form.job.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                    <div><label class="block mb-2 text-sm text-gray-700">{{ form.housing_status.label }}</label>{{ form.housing_status }}{% for error in form.housing_status.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                    <div><label class="block mb-2 text-sm text-gray-700">{{ form.insurance.label }}</label>{{ form.insurance }}{% for error in form.insurance.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                    
                    <!-- Rental Fields -->
                    <div id="rental-fields" class="col-span-full md:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6 bg-amber-50/50 p-4 rounded-xl border border-amber-100 hidden fade-in">
                        <div><label class="block mb-2 text-sm text-gray-700 font-bold">{{ form.house_mortgage.label }}</label>{{ form.house_mortgage }}{% for error in form.house_mortgage.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                        <div><label class="block mb-2 text-sm text-gray-700 font-bold">{{ form.house_rent.label }}</label>{{ form.house_rent }}{% for error in form.house_rent.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                    </div>

                    <div class="md:col-span-3"><label class="block mb-2 text-sm text-gray-700">{{ form.address.label }}</label>{{ form.address }}{% for error in form.address.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                </div>
            </div>

            <!-- 3. CASE INFORMATION -->
            <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                <h2 class="text-lg font-bold text-amber-800 mb-6 pb-2 border-b border-amber-100">3. اطلاعات پرونده</h2>
                
                <div class="mb-6">
                    <label class="block mb-2 text-sm text-gray-700 font-bold">{{ form.case_type.label }}</label>
                    {{ form.case_type }}
                    {% for error in form.case_type.errors %}<p class="error-text">{{ error }}</p>{% endfor %}
                </div>

                <!-- Formsets -->
                <div id="disability-section" class="bg-yellow-50 rounded-xl p-6 border border-yellow-200 mt-6 hidden"><h3 class="font-bold text-yellow-800 mb-4">اطلاعات معلولیت</h3>{{ disabilities.management_form }}<div id="disability-container" class="space-y-4">{% for form in disabilities %}<div class="formset-row bg-white p-4 rounded-xl border border-yellow-200 shadow-sm relative grid grid-cols-1 md:grid-cols-2 gap-4">{% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}<div class="absolute top-2 left-2"><div class="hidden">{{ form.DELETE }}</div><button type="button" class="delete-row-btn text-red-400 hover:text-red-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div><div><label class="block mb-2 text-sm text-gray-600">نوع معلولیت</label>{{ form.disability_type }}</div><div><label class="block mb-2 text-sm text-gray-600">شدت معلولیت</label>{{ form.disability_level }}</div></div>{% endfor %}</div><div class="mt-4 flex justify-end"><button type="button" id="add-disability-btn" class="bg-yellow-200 px-4 py-2 rounded-lg text-sm font-medium hover:bg-yellow-300 transition">افزودن</button></div></div>
                <div id="reason-section" class="bg-rose-50 rounded-xl p-6 border border-rose-200 mt-6 hidden"><h3 class="font-bold text-rose-800 mb-4">علت تشکیل پرونده (اجتماعی)</h3>{{ reasons.management_form }}<div id="reason-container" class="space-y-4">{% for form in reasons %}<div class="formset-row bg-white p-4 rounded-xl border border-rose-200 shadow-sm relative">{% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}<div class="absolute top-2 left-2"><div class="hidden">{{ form.DELETE }}</div><button type="button" class="delete-row-btn text-red-400 hover:text-red-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div><div><label class="block mb-2 text-sm text-gray-600">علت</label>{{ form.reason }}</div></div>{% endfor %}</div><div class="mt-4 flex justify-end"><button type="button" id="add-reason-btn" class="bg-rose-200 px-4 py-2 rounded-lg text-sm font-medium hover:bg-rose-300 transition">افزودن</button></div></div>
                <div id="recovered-section" class="bg-blue-50 rounded-xl p-6 border border-blue-200 mt-6 hidden"><h3 class="font-bold text-blue-800 mb-4">اطلاعات بهبود یافتگان</h3>{{ recovered.management_form }}<div id="recovered-container" class="space-y-4">{% for form in recovered %}<div class="formset-row bg-white p-4 rounded-xl border border-blue-200 shadow-sm relative grid grid-cols-1 md:grid-cols-2 gap-4">{% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}<div class="absolute top-2 left-2"><div class="hidden">{{ form.DELETE }}</div><button type="button" class="delete-row-btn text-red-400 hover:text-red-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div><div><label class="block mb-2 text-sm text-gray-600">علت</label>{{ form.reason }}</div><div><label class="block mb-2 text-sm text-gray-600">مهارت</label>{{ form.skill }}</div><div><label class="block mb-2 text-sm text-gray-600">سابقه</label>{{ form.work_experience }}</div><div><label class="block mb-2 text-sm text-gray-600">بیمه</label>{{ form.insurance_type }}</div></div>{% endfor %}</div><div class="mt-4 flex justify-end"><button type="button" id="add-recovered-btn" class="bg-blue-200 px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-300 transition">افزودن</button></div></div>
            </div>

            <!-- 4. FINANCIAL -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                    <h2 class="text-lg font-bold text-amber-800 mb-6 pb-2 border-b border-amber-100">4. اطلاعات بانکی</h2>
                    <div class="space-y-4">
                        <div><label class="block mb-2 text-sm text-gray-700">{{ form.bank_card_number.label }}</label>{{ form.bank_card_number }}{% for error in form.bank_card_number.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                        <div><label class="block mb-2 text-sm text-gray-700">{{ form.bank_account_number.label }}</label>{{ form.bank_account_number }}{% for error in form.bank_account_number.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                        <div><label class="block mb-2 text-sm text-gray-700">{{ form.bank_shaba_number.label }}</label><div class="relative">{{ form.bank_shaba_number }}<span class="absolute left-3 top-3 text-gray-400 font-bold">IR</span></div>{% for error in form.bank_shaba_number.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                    <h2 class="text-lg font-bold text-purple-600 mb-6 pb-2 border-b border-purple-100">5. آمار اعضا</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2"><label class="block mb-2 text-sm text-gray-700">{{ form.marrige_status.label }}</label>{{ form.marrige_status }}{% for error in form.marrige_status.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                        <div><label class="block mb-2 text-sm text-gray-700">{{ form.children_count.label }}</label>{{ form.children_count }}{% for error in form.children_count.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                        <div><label class="block mb-2 text-sm text-gray-700">{{ form.dependents_count.label }}</label>{{ form.dependents_count }}{% for error in form.dependents_count.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                        <div><label class="block mb-2 text-sm text-gray-700">{{ form.brothers_count.label }}</label>{{ form.brothers_count }}{% for error in form.brothers_count.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                        <div><label class="block mb-2 text-sm text-gray-700">{{ form.sisters_count.label }}</label>{{ form.sisters_count }}{% for error in form.sisters_count.errors %}<p class="error-text">{{ error }}</p>{% endfor %}</div>
                    </div>
                </div>
            </div>

            <!-- 6. FAMILY -->
            <div class="bg-teal-50 rounded-2xl shadow-sm p-6 border border-teal-200">
                <h2 class="text-lg font-bold text-teal-800 mb-6">6. اعضای خانواده</h2>
                {{ family.management_form }}
                <div id="family-container" class="space-y-6">
                    {% for form in family %}
                        <div class="formset-row bg-white p-5 rounded-xl border-2 {% if forloop.first %}border-blue-300{% elif forloop.counter0 == 1 %}border-pink-300{% else %}border-teal-100{% endif %} relative">
                            {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                            <div class="mb-4 pb-2 border-b flex justify-between items-center"><h3 class="font-bold">{% if forloop.first %}<span class="text-blue-600">پدر</span>{% elif forloop.counter0 == 1 %}<span class="text-pink-600">مادر</span>{% else %}<span class="text-teal-600">عضو جدید</span>{% endif %}</h3>{% if not forloop.first and not forloop.counter0 == 1 %}<div class=""><div class="hidden">{{ form.DELETE }}</div><button type="button" class="delete-row-btn text-red-400 hover:text-red-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div>{% endif %}</div>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div><label class="block mb-2 text-sm text-gray-600">نسبت</label>{% if forloop.first or forloop.counter0 == 1 %}<input type="text" value="{% if forloop.first %}پدر{% else %}مادر{% endif %}" disabled class="bg-gray-100 w-full border border-gray-300 rounded-lg p-3 text-sm"><div class="hidden">{{ form.relation }}</div>{% else %}{{ form.relation }}{% endif %}</div>
                                <div><label class="block mb-2 text-sm text-gray-600">نام</label>{{ form.first_name }}</div><div><label class="block mb-2 text-sm text-gray-600">نام خانوادگی</label>{{ form.last_name }}</div><div><label class="block mb-2 text-sm text-gray-600">کد ملی</label>{{ form.national_id }}</div><div><label class="block mb-2 text-sm text-gray-600">تحصیلات</label>{{ form.education }}</div><div><label class="block mb-2 text-sm text-gray-600">شغل</label>{{ form.job }}</div><div class="md:col-span-2"><label class="block mb-2 text-sm text-gray-600">توضیحات</label>{{ form.description }}</div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <div class="mt-6 flex justify-end"><button type="button" id="add-family-btn" class="bg-teal-200 px-4 py-2 rounded-lg text-sm font-medium hover:bg-teal-300 transition">افزودن عضو</button></div>
            </div>

            <!-- 7. NOTES -->
            <div class="bg-indigo-50 rounded-2xl shadow-sm p-6 border border-indigo-200">
                <h2 class="text-lg font-bold text-indigo-800 mb-4">7. یادداشت‌ها و توضیحات</h2>
                {{ notes.management_form }}
                <div id="notes-container" class="space-y-4">
                    {% for form in notes %}
                        <div class="formset-row bg-white p-4 rounded-xl border border-indigo-200 shadow-sm relative">
                            {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                            <div class="absolute top-2 left-2"><div class="hidden">{{ form.DELETE }}</div><button type="button" class="delete-row-btn text-red-400 hover:text-red-600"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div>
                            <div><label class="block mb-2 text-sm text-gray-600">متن یادداشت</label>{{ form.note }}</div>
                        </div>
                    {% endfor %}
                </div>
                <div class="mt-4 flex justify-end"><button type="button" id="add-note-btn" class="bg-indigo-200 px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-300 transition">افزودن یادداشت</button></div>
            </div>

            <!-- SUBMIT -->
            <div class="flex items-center justify-end pt-8 sticky bottom-4 z-40">
                <button type="submit" class="bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-12 rounded-xl shadow-2xl transition-all hover:-translate-y-1">
                    ذخیره تغییرات
                </button>
            </div>
        </form>

        <!-- HIDDEN TEMPLATES (Identical copies) -->
        <div id="empty-disability-form" class="hidden"><div class="formset-row bg-white p-4 rounded-xl border border-yellow-200 shadow-sm relative grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"><div class="absolute top-2 left-2"><div class="hidden">{{ disabilities.empty_form.DELETE }}</div><button type="button" class="delete-row-btn text-red-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div><div><label class="block mb-2 text-sm text-gray-600">نوع معلولیت</label>{{ disabilities.empty_form.disability_type }}</div><div><label class="block mb-2 text-sm text-gray-600">شدت معلولیت</label>{{ disabilities.empty_form.disability_level }}</div></div></div>
        <div id="empty-reason-form" class="hidden"><div class="formset-row bg-white p-4 rounded-xl border border-rose-200 shadow-sm relative mt-4"><div class="absolute top-2 left-2"><div class="hidden">{{ reasons.empty_form.DELETE }}</div><button type="button" class="delete-row-btn text-red-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div><div><label class="block mb-2 text-sm text-gray-600">علت</label>{{ reasons.empty_form.reason }}</div></div></div>
        <div id="empty-recovered-form" class="hidden"><div class="formset-row bg-white p-4 rounded-xl border border-emerald-200 shadow-sm relative grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"><div class="absolute top-2 left-2"><div class="hidden">{{ recovered.empty_form.DELETE }}</div><button type="button" class="delete-row-btn text-red-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div><div><label class="block mb-2 text-sm text-gray-600">علت</label>{{ recovered.empty_form.reason }}</div><div><label class="block mb-2 text-sm text-gray-600">مهارت</label>{{ recovered.empty_form.skill }}</div><div><label class="block mb-2 text-sm text-gray-600">سابقه</label>{{ recovered.empty_form.work_experience }}</div><div><label class="block mb-2 text-sm text-gray-600">بیمه</label>{{ recovered.empty_form.insurance_type }}</div></div></div>
        <div id="empty-note-form" class="hidden"><div class="formset-row bg-white p-4 rounded-xl border border-indigo-200 shadow-sm relative mt-4"><div class="absolute top-2 left-2"><div class="hidden">{{ notes.empty_form.DELETE }}</div><button type="button" class="delete-row-btn text-red-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div><div><label class="block mb-2 text-sm text-gray-600">متن یادداشت</label>{{ notes.empty_form.note }}</div></div></div>
        <div id="empty-family-form" class="hidden"><div class="formset-row bg-white p-5 rounded-xl border-2 border-teal-100 shadow-sm relative mt-4"><div class="mb-4 pb-2 border-b flex justify-between"><h3 class="font-bold text-teal-600">عضو جدید</h3><div class="absolute top-4 left-4"><div class="hidden">{{ family.empty_form.DELETE }}</div><button type="button" class="delete-row-btn text-red-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div></div><div class="grid grid-cols-1 md:grid-cols-4 gap-4"><div><label class="block mb-2 text-sm text-gray-600">نسبت</label>{{ family.empty_form.relation }}</div><div><label class="block mb-2 text-sm text-gray-600">نام</label>{{ family.empty_form.first_name }}</div><div><label class="block mb-2 text-sm text-gray-600">نام خانوادگی</label>{{ family.empty_form.last_name }}</div><div><label class="block mb-2 text-sm text-gray-600">کد ملی</label>{{ family.empty_form.national_id }}</div><div><label class="block mb-2 text-sm text-gray-600">تحصیلات</label>{{ family.empty_form.education }}</div><div><label class="block mb-2 text-sm text-gray-600">شغل</label>{{ family.empty_form.job }}</div><div class="md:col-span-2"><label class="block mb-2 text-sm text-gray-600">توضیحات</label>{{ family.empty_form.description }}</div></div></div></div>

    </main>
    
    <script>
        jalaliDatepicker.startWatch({ minDate: "attr", maxDate: "attr" });

        document.addEventListener('DOMContentLoaded', function() {
            // Military Logic
            const genderSelect = document.getElementById('id_gender');
            const militarySelect = document.getElementById('id_military_serveice'); 
            function toggleMilitary() {
                if(!genderSelect || !militarySelect) return;
                if(genderSelect.value === 'M') {
                    militarySelect.removeAttribute('disabled');
                    militarySelect.classList.remove('bg-gray-200');
                } else {
                    militarySelect.setAttribute('disabled', 'disabled');
                    militarySelect.value = '';
                    militarySelect.classList.add('bg-gray-200');
                }
            }
            if(genderSelect) { toggleMilitary(); genderSelect.addEventListener('change', toggleMilitary); }

            // Rental Logic
            const housingSelect = document.getElementById('id_housing_status');
            const rentalContainer = document.getElementById('rental-fields');
            function toggleRental() {
                if (housingSelect && rentalContainer) {
                    if (housingSelect.value === 'rental') rentalContainer.classList.remove('hidden');
                    else rentalContainer.classList.add('hidden');
                }
            }
            if (housingSelect) { toggleRental(); housingSelect.addEventListener('change', toggleRental); }

            // Case Type Logic
            const caseTypeSelect = document.getElementById('id_case_type');
            function toggleSections() {
                document.getElementById('disability-section').classList.add('hidden');
                document.getElementById('reason-section').classList.add('hidden');
                document.getElementById('recovered-section').classList.add('hidden');
                const val = caseTypeSelect.value;
                if(val === 'rehab') document.getElementById('disability-section').classList.remove('hidden');
                if(val === 'social') document.getElementById('reason-section').classList.remove('hidden');
                if(val === 'recovered') document.getElementById('recovered-section').classList.remove('hidden');
            }
            if(caseTypeSelect) { toggleSections(); caseTypeSelect.addEventListener('change', toggleSections); }

            // Add Form Logic
            function addForm(btnId, containerId, totalId, emptyId) {
                const btn = document.getElementById(btnId);
                if(!btn) return;
                btn.addEventListener('click', function() {
                    const totalInput = document.getElementById(totalId);
                    const container = document.getElementById(containerId);
                    const count = parseInt(totalInput.value);
                    const newHtml = document.getElementById(emptyId).innerHTML.replace(/__prefix__/g, count);
                    container.insertAdjacentHTML('beforeend', newHtml);
                    totalInput.value = count + 1;
                });
            }
            addForm('add-disability-btn', 'disability-container', 'id_disabilities-TOTAL_FORMS', 'empty-disability-form');
            addForm('add-reason-btn', 'reason-container', 'id_reasons-TOTAL_FORMS', 'empty-reason-form');
            addForm('add-recovered-btn', 'recovered-container', 'id_recovered_reasons-TOTAL_FORMS', 'empty-recovered-form');
            addForm('add-note-btn', 'notes-container', 'id_casenotes_set-TOTAL_FORMS', 'empty-note-form');
            addForm('add-family-btn', 'family-container', 'id_family-TOTAL_FORMS', 'empty-family-form');

            // Delete Logic
            document.body.addEventListener('click', function(e) {
                if (e.target.closest('.delete-row-btn')) {
                    const btn = e.target.closest('.delete-row-btn');
                    const row = btn.closest('.formset-row'); 
                    const checkbox = row.querySelector('input[type="checkbox"]');
                    if (checkbox) { checkbox.checked = true; }
                    row.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
